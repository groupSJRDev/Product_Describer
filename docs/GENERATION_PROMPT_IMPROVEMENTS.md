# Generation Prompt Improvements for Nano Banana Pro

## Overview

This document outlines potential improvements for the Nano Banana Pro (Gemini 3 Pro Image) generation prompt found in `generate_test.py`. This prompt takes the YAML specifications generated by GPT Vision analysis and instructs the model to create accurate product images.

**Current Location**: `src/product_describer/generate_test.py` (lines 89-114)

**Note**: This is separate from the analysis prompt used by GPT Vision. For analysis prompt improvements, see `ANALYSIS_PROMPT_IMPROVEMENTS.md`.

---

## Current Generation Prompt Structure

```python
full_prompt = f"""

Please generate product with these exact ratios. 
Exact label of reference.
No metrics on the final image.

{yaml_specs}

Pay special attention to:
- Exact color hex codes
- Material properties (transparency, refraction, reflection)
- Geometry and proportions
- Exact curves and angles
- Optical characteristics

DO NOT deviate from ANY specifications.
DO NOT add details to the product not described.

{custom_prompt}

You must follow all metric descriptions EXACTLY. Product maintains instructed color and exact dimensions.
"""
```

### Current Approach Analysis

**Strengths**:
- Clear emphasis on exact adherence ("DO NOT deviate")
- Highlights critical aspects (colors, materials, geometry)
- Separates structural instructions from custom styling
- Uses reference image + specs together

**Potential Issues**:
- Repetitive emphasis might create confusion
- No guidance on handling specification conflicts
- Lacks explicit tolerance guidance
- No verification checklist
- Missing priority hierarchy when trade-offs are needed

---

## Proposed Improvements

### 1. Structured Priority Hierarchy

**Current**: All specifications treated with equal "EXACT" emphasis

**Proposed**:
```python
full_prompt = f"""
You are generating a product image from technical specifications and a reference image.

CRITICAL REQUIREMENTS (Must be exact):
- Color hex codes: {extract_colors_from_yaml(yaml_specs)}
- Overall dimensions and proportions
- Material type and transparency
- Label placement and content

IMPORTANT DETAILS (Should match closely):
- Surface textures and finish
- Light refraction behavior
- Edge radii and curves
- Shadow characteristics

FLEXIBLE ASPECTS (Can vary for photorealism):
- Exact lighting setup
- Background treatment
- Camera angle within ±5°

{yaml_specs}

{custom_prompt}

VERIFICATION: After generation, confirm:
- Colors match hex codes within ±2%
- Proportions match width:height ratios
- Material properties are consistent with specifications
"""
```

**Rationale**:
- Prioritizes what matters most (colors, dimensions, materials)
- Gives model permission to be creative where appropriate
- Explicit verification criteria

---

### 2. Specification Conflict Resolution

**Problem**: YAML specs might contain contradictions or impossibilities

**Proposed Addition**:
```
CONFLICT RESOLUTION RULES:
If specifications conflict:
1. Prioritize dimensions over aesthetic details
2. Prioritize measured values over inferred values
3. Prioritize reference image for label text/graphics
4. Choose the most conservative tolerance interpretation

If a specification seems physically impossible (e.g., transparent and opaque):
- Default to reference image appearance
- Note the conflict in response
```

**Rationale**:
- Prevents model paralysis when specs conflict
- Establishes clear decision hierarchy
- Aligns with real manufacturing constraints

---

### 3. Explicit Tolerance Guidance

**Current**: "EXACTLY" is vague - what precision is realistic?

**Proposed**:
```
TOLERANCE STANDARDS:
- Colors: Within ±2% of hex value (Delta E < 2)
- Dimensions: Within ±2% of specified measurements
- Angles: Within ±2 degrees
- Opacity/transparency: Within ±5%

These tolerances represent professional manufacturing standards. 
Match as closely as possible, but perfection within these bounds is acceptable.
```

**Rationale**:
- Sets realistic expectations
- Prevents model from "giving up" on impossible precision
- Aligns with actual product manufacturing tolerances

---

### 4. Reference Image Guidance

**Current**: Reference image included but role unclear

**Proposed**:
```
REFERENCE IMAGE USAGE:
The provided reference image should be used for:
✓ Label text, logos, and graphic exact reproduction
✓ Overall aesthetic and style guidance
✓ Resolving ambiguities in YAML specifications
✓ Confirming material appearance and finish

Do NOT copy from reference image:
✗ Exact lighting setup (use studio lighting per custom prompt)
✗ Background elements
✗ Image artifacts or imperfections
✗ Camera distortions or perspective issues
```

**Rationale**:
- Clarifies when to trust reference vs specs
- Prevents copying unwanted aspects
- Guides appropriate use of reference material

---

### 5. Multi-Step Reasoning Chain

**Current**: Single-shot generation instruction

**Proposed**:
```
GENERATION PROCESS:
Before generating, mentally verify:
1. Parse all specifications and identify critical measurements
2. Check for any conflicting requirements
3. Confirm color values are valid hex codes
4. Verify proportions make physical sense
5. Plan lighting that shows material properties

Then generate the image following the specifications.

After generation, self-check:
- Do colors match the hex codes?
- Are proportions correct?
- Does the material appear as specified?
- Are labels readable and correctly placed?
```

**Rationale**:
- Encourages chain-of-thought processing
- May improve accuracy through self-verification
- Mimics how a designer would approach the task

---

### 6. Handling Numerical Precision

**Current**: Bare numbers like "8.5 inches" or "#D9E7EF"

**Proposed**:
```python
# Pre-process YAML to add context
processed_specs = add_measurement_context(yaml_specs)

# Example output:
"""
width: 8.5 inches
  (This is the PRIMARY dimension - all other measurements scale from this)
  (In reference image, this spans approximately 85% of frame width)
  
color_primary: #D9E7EF
  (Aqua/teal tone, RGB: 217, 231, 239)
  (Reference swatch: semi-translucent silicone appearance)
"""
```

**Rationale**:
- Numbers with context are easier for AI to parse
- Cross-references with reference image anchor understanding
- Multiple representations reduce ambiguity

---

### 7. Output Quality Constraints

**Current**: "No metrics on the final image" (might be ignored)

**Proposed**:
```
OUTPUT REQUIREMENTS:
✓ Generate at requested resolution ({resolution})
✓ Use {aspect_ratio} aspect ratio exactly
✓ Include ONLY the product (no dimension lines, annotations, or measurements)
✓ Clean background as specified in custom prompt
✓ Professional lighting that reveals material properties

✗ Do NOT include measurement callouts
✗ Do NOT add text unless specified in product labels
✗ Do NOT add watermarks or borders
✗ Do NOT show rulers, grids, or reference objects
```

**Rationale**:
- Explicit positive and negative requirements
- Prevents common unwanted artifacts
- Clear checklist format

---

### 8. Error Recovery Guidance

**Current**: No guidance on what to do if generation fails

**Proposed**:
```
IF GENERATION ENCOUNTERS ISSUES:
- If colors can't be matched exactly, get as close as possible and note variance
- If geometry seems impossible, simplify to closest achievable form
- If material properties conflict, prioritize translucency over texture
- If labels are unreadable at resolution, increase contrast

In all cases, explain what adjustments were made.
```

**Rationale**:
- Graceful degradation instead of failure
- Transparency about limitations
- Guidance for model's decision-making

---

## Testing Framework

### Metrics for Evaluation

For each prompt variation, measure:

1. **Color Accuracy**
   - Extract RGB from generated image
   - Calculate Delta E from target hex codes
   - Target: <2 Delta E for 90% of colors

2. **Dimensional Accuracy**
   - Measure key dimensions in generated image
   - Compare to specified ratios
   - Target: <3% error on primary dimensions

3. **Material Fidelity**
   - Subjective rating of transparency/material appearance
   - 5-point scale rated by 3 reviewers
   - Target: Average score >4.0

4. **Label Quality**
   - OCR accuracy of generated labels vs. reference
   - Target: >95% character accuracy

5. **Unwanted Artifacts**
   - Count of dimension lines, rulers, or annotations
   - Target: Zero unwanted artifacts

### A/B Testing Protocol

1. **Baseline**: Current prompt (10 generations)
2. **Variant A**: Hierarchical priorities (10 generations)
3. **Variant B**: Explicit tolerances (10 generations)
4. **Variant C**: Multi-step reasoning (10 generations)
5. **Variant D**: Combined best elements (10 generations)

**Test Product**: Use consistent product (e.g., Stasher bag) for all tests

**Statistical Significance**: Use t-test with p<0.05 threshold

---

## Implementation Roadmap

### Phase 1: Analysis (Week 1)
- [ ] Establish baseline metrics for current prompt
- [ ] Run 20+ generations with current prompt
- [ ] Measure color/dimension accuracy
- [ ] Document common failure modes

### Phase 2: Single-Variable Tests (Week 2-3)
- [ ] Test priority hierarchy variant
- [ ] Test tolerance guidance variant
- [ ] Test reference image guidance variant
- [ ] Measure each against baseline

### Phase 3: Combination Testing (Week 4)
- [ ] Combine best-performing elements
- [ ] Test combined prompt
- [ ] Validate against baseline

### Phase 4: Production (Week 5)
- [ ] Deploy winning prompt variant
- [ ] Update documentation
- [ ] Monitor production results

---

## Customization Points

The prompt currently supports customization via:

1. **Environment Variable**: `GENERATION_PROMPT`
2. **File**: `temp/<PRODUCT_NAME>/generation_prompt.txt`
3. **Default**: Studio photography instructions

### Recommended Custom Prompt Templates

**Studio Product Photography**:
```
Create a professional studio product photograph.
Clean, even lighting revealing all material details.
Pure white background.
Centered composition, slight overhead angle.
```

**Lifestyle Context**:
```
Show the product in realistic use context.
Natural lighting, lifestyle setting.
Product should be the focal point but in environment.
Maintain exact specifications while creating authentic scene.
```

**Technical Documentation**:
```
Generate technical documentation style image.
Neutral lighting, no shadows.
Flat, straight-on perspective.
Maximum clarity of all features and details.
```

---

## Notes and Considerations

### Why This Matters

Unlike traditional rendering engines, AI image generators:
- Don't have precise numerical control
- Operate probabilistically
- May "hallucinate" details not in specs
- Can struggle with exact color matching
- Require careful prompt engineering

### Model-Specific Considerations

**Gemini 3 Pro Image (Nano Banana Pro)**:
- Excellent with complex scenes
- Good material rendering
- Can struggle with exact numerical precision
- Responds well to hierarchical instructions
- Benefits from verification checklists

### Future Explorations

- **Few-shot learning**: Include 2-3 example pairs (spec → image)
- **Iterative refinement**: Generate, critique, regenerate
- **Multi-model ensemble**: Generate with multiple models, pick best
- **Specification validation**: Pre-check YAML for conflicts before generation

---

## Changelog

- **2026-01-26**: Initial document created based on analysis of current prompt
